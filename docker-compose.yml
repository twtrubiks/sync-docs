
x-base-app-setting: &x-base-app
  image: sync-docs
  build: ./backend
  volumes:
    - ./backend:/sync-docs

services:

    test:
      # 這個服務專門用來跑測試
      # docker compose up   # 啟動常規服務，跳過測試。
      # docker compose up test # 只運行測試及其直接依賴。
      # docker compose --profile testing up # 啟動所有 被標記 profile: "testing" 的服務
      <<: *x-base-app
      command: bash -c "pytest --cov=. --cov-report=html"
      # command: bash -c "pytest -s" # print log
      profiles:
        - "testing"

    backend:
      <<: *x-base-app
      command: bash -c "python manage.py runserver 0.0.0.0:8000"
      restart: always
      ports:
        - "8000:8000"
      environment:
        # TODO: 正式環境請更換為安全密鑰和密碼
        - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:-django-insecure-dev-only-key}
        - DJANGO_DEBUG=${DJANGO_DEBUG:-True}
        - DJANGO_ALLOWED_HOSTS=${DJANGO_ALLOWED_HOSTS:-*}
        - POSTGRES_HOST=django-postgres
        - POSTGRES_DB=${POSTGRES_DB:-postgres}
        - POSTGRES_USER=${POSTGRES_USER:-myuser}
        - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-password123}
        - REDIS_HOST=django-redis
        - CORS_ALLOWED_ORIGINS=${CORS_ALLOWED_ORIGINS:-http://localhost:5173,http://127.0.0.1:5173}
        - GEMINI_API_KEY=${GEMINI_API_KEY:-}
        - GEMINI_MODEL=${GEMINI_MODEL:-gemini-3-flash-preview}
      depends_on:
        - django-postgres
        - django-redis

    django-postgres:
      image: postgres:18
      # ports:
      #   - "5432:5432"
      environment:
        # TODO: 正式環境請更換為安全密碼
        - POSTGRES_DB=${POSTGRES_DB:-postgres}
        - POSTGRES_USER=${POSTGRES_USER:-myuser}
        - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-password123}
        - PGDATA=/var/lib/postgresql/data/pgdata
      volumes:
        - db-data:/var/lib/postgresql/data/pgdata

    django-redis:
      image: redis:8-alpine
      restart: always
      command: ["redis-server", "--appendonly", "yes"]
      # ports:
      #   - "6379:6379"
      volumes:
        - redis-data:/data

    # 前端 SvelteKit 服務
    frontend:
      build: ./frontend
      container_name: sveltekit_frontend
      command: sh -c "npx svelte-kit sync && npm run dev"
      volumes:
        - ./frontend:/app
        - /app/node_modules # 一個小技巧：防止本地的 node_modules 覆蓋容器中已安裝的
      ports:
        - "5173:5173"
      depends_on:
        - backend

volumes:
  db-data:
  redis-data: