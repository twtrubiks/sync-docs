# ğŸ—ï¸ SyncDocs æ¶æ§‹è¨­è¨ˆæ–‡æª”

> æœ¬æ–‡æª”è©³ç´°èªªæ˜ SyncDocs çš„ç³»çµ±æ¶æ§‹ã€è¨­è¨ˆæ±ºç­–å’ŒæŠ€è¡“é¸å‹ã€‚é©åˆæƒ³æ·±å…¥ç†è§£ç³»çµ±è¨­è¨ˆçš„å­¸ç¿’è€…ã€‚

---

## ğŸ“‹ ç›®éŒ„

- [ç³»çµ±æ¦‚è¦½](#ç³»çµ±æ¦‚è¦½)
- [æŠ€è¡“æ¶æ§‹](#æŠ€è¡“æ¶æ§‹)
- [æ•¸æ“šæµå‘](#æ•¸æ“šæµå‘)
- [æ ¸å¿ƒæ¨¡çµ„è¨­è¨ˆ](#æ ¸å¿ƒæ¨¡çµ„è¨­è¨ˆ)
- [è¨­è¨ˆæ¨¡å¼](#è¨­è¨ˆæ¨¡å¼)
- [æŠ€è¡“é¸å‹ç†ç”±](#æŠ€è¡“é¸å‹ç†ç”±)
- [å®‰å…¨æ€§è¨­è¨ˆ](#å®‰å…¨æ€§è¨­è¨ˆ)
- [æ•ˆèƒ½è€ƒé‡](#æ•ˆèƒ½è€ƒé‡)
- [æ“´å±•æ€§è¨­è¨ˆ](#æ“´å±•æ€§è¨­è¨ˆ)
- [å»¶ä¼¸é–±è®€](#å»¶ä¼¸é–±è®€)

---

## ğŸ¯ ç³»çµ±æ¦‚è¦½

### å°ˆæ¡ˆå®šä½

SyncDocs æ˜¯ä¸€å€‹**æ•™å­¸å‹**çš„å³æ™‚å”ä½œæ–‡ä»¶ç·¨è¼¯å™¨ï¼Œå±•ç¤ºäº†ç¾ä»£å…¨ç«¯é–‹ç™¼çš„æ ¸å¿ƒæŠ€è¡“ï¼š
- å‰å¾Œç«¯åˆ†é›¢
- RESTful API è¨­è¨ˆ
- WebSocket å³æ™‚é€šè¨Š
- å¯Œæ–‡æœ¬ç·¨è¼¯
- å¤šç”¨æˆ¶å”ä½œ

### æ ¸å¿ƒåŠŸèƒ½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    SyncDocs åŠŸèƒ½æ¶æ§‹                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. ç”¨æˆ¶ç®¡ç†      â”‚ è¨»å†Šã€ç™»å…¥ã€JWT èªè­‰                â”‚
â”‚  2. æ–‡ä»¶ç®¡ç†      â”‚ CRUDã€åˆ†äº«ã€æ¬Šé™æ§åˆ¶                â”‚
â”‚  3. å¯Œæ–‡æœ¬ç·¨è¼¯    â”‚ Quill.jsã€å·¥å…·åˆ—ã€æ ¼å¼åŒ–             â”‚
â”‚  4. å³æ™‚å”ä½œ      â”‚ WebSocketã€Delta åŒæ­¥ã€å»£æ’­ã€æ¸¸æ¨™ä½ç½®ã€åœ¨ç·šç‹€æ…‹ â”‚
â”‚  5. è‡ªå‹•ä¿å­˜      â”‚ Debounceã€ç‹€æ…‹ç®¡ç†                  â”‚
â”‚  6. ç‰ˆæœ¬æ­·å²      â”‚ å®Œæ•´å¿«ç…§ã€ç‰ˆæœ¬åˆ—è¡¨ã€é‚„åŸç‰ˆæœ¬        â”‚
â”‚  7. AI å¯«ä½œåŠ©æ‰‹   â”‚ æ–‡å­—æ‘˜è¦ã€æ½¤ç¨¿ã€Gemini API          â”‚
â”‚  8. è©•è«–ç³»çµ±      â”‚ è©•è«–ã€å›è¦†ã€å³æ™‚åŒæ­¥ã€æ¬Šé™æ§åˆ¶       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›ï¸ æŠ€è¡“æ¶æ§‹

### æ•´é«”æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å®¢æˆ¶ç«¯å±¤ (Client)                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                       â”‚
â”‚  â”‚  ç€è¦½å™¨       â”‚        â”‚  SvelteKit   â”‚                       â”‚
â”‚  â”‚  (Chrome,    â”‚â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  å‰ç«¯æ‡‰ç”¨    â”‚                       â”‚
â”‚  â”‚   Firefox)   â”‚        â”‚  (Port 5173) â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                       â”‚
â”‚                                   â”‚                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚                     â”‚
                         â–¼                     â–¼
              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
              â”‚   HTTP API   â”‚      â”‚  WebSocket   â”‚
              â”‚  (REST)      â”‚      â”‚   (WS)       â”‚
              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    â”‚   æ‡‰ç”¨å±¤ (Application)   â”‚                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                    â–¼                     â–¼                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚  Django Ninja API  â”‚  â”‚ Django Channels    â”‚                 â”‚
â”‚  â”‚  - èªè­‰            â”‚  â”‚ - WebSocket        â”‚                 â”‚
â”‚  â”‚  - æ–‡ä»¶ CRUD       â”‚  â”‚ - å³æ™‚å”ä½œ         â”‚                 â”‚
â”‚  â”‚  - å”ä½œè€…ç®¡ç†      â”‚  â”‚ - Channel Layer    â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚            â”‚                         â”‚                            â”‚
â”‚            â–¼                         â–¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚          Django ORM (è³‡æ–™è¨ªå•å±¤)            â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       â”‚     æ•¸æ“šå±¤ (Data)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                       â–¼                                            â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚         â”‚   PostgreSQL        â”‚        â”‚    Redis     â”‚          â”‚
â”‚         â”‚   - ç”¨æˆ¶è³‡æ–™        â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”‚  - æœƒè©±      â”‚          â”‚
â”‚         â”‚   - æ–‡ä»¶å…§å®¹        â”‚        â”‚  - Channel   â”‚          â”‚
â”‚         â”‚   - åˆ†äº«é—œä¿‚        â”‚        â”‚    Layer     â”‚          â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æŠ€è¡“æ£§ä¸€è¦½

| å±¤ç´š | æŠ€è¡“ | ç‰ˆæœ¬ | ç”¨é€” |
|------|------|------|------|
| **å‰ç«¯** | SvelteKit | 2.x | å…¨ç«¯æ¡†æ¶ |
| | Svelte | 5.x | UI æ¡†æ¶ |
| | TypeScript | 5.x | å‹åˆ¥å®‰å…¨ |
| | Quill.js | 2.x | å¯Œæ–‡æœ¬ç·¨è¼¯å™¨ |
| | Tailwind CSS | 4.x | æ¨£å¼æ¡†æ¶ |
| **å¾Œç«¯** | Django | 5.2 | Web æ¡†æ¶ |
| | Django Ninja | 1.4 | API æ¡†æ¶ |
| | Django Channels | 4.x | WebSocket |
| | Google Gen AI | 1.0+ | AI åŠŸèƒ½ |
| | Python | 3.12 | ç¨‹å¼èªè¨€ |
| **æ•¸æ“š** | PostgreSQL | 18 | ä¸»è³‡æ–™åº« |
| | Redis | 8-alpine | å¿«å– & Channel Layer |
| **éƒ¨ç½²** | Docker | latest | å®¹å™¨åŒ– |
| | Docker Compose | latest | ç·¨æ’ |
| **æ¸¬è©¦** | pytest | 8.x | æ¸¬è©¦æ¡†æ¶ |
| | Vitest | 3.x | å‰ç«¯æ¸¬è©¦ |

---

## ğŸ”„ æ•¸æ“šæµå‘

### 1. ç”¨æˆ¶èªè­‰æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ç€è¦½å™¨  â”‚                           â”‚ Django Ninja â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                           â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                       â”‚
     â”‚  1. POST /api/token/pair              â”‚
     â”‚     { username, password }            â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                                       â”‚
     â”‚                          2. é©—è­‰å¯†ç¢¼  â”‚
     â”‚                             æŸ¥è©¢ DB   â”‚
     â”‚                                  â–¼    â”‚
     â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”
     â”‚                           â”‚ PostgreSQL  â”‚
     â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”˜
     â”‚                                  â–²    â”‚
     â”‚                          3. è¿”å›ç”¨æˆ¶ â”‚
     â”‚                                       â”‚
     â”‚              4. ç”Ÿæˆ JWT Token        â”‚
     â”‚                (access + refresh)     â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚  { access, refresh }                  â”‚
     â”‚                                       â”‚
     â”‚  5. å­˜å„²åˆ° localStorage               â”‚
     â”‚     â””â”€ access_token                   â”‚
     â”‚                                       â”‚
     â”‚  6. å¾ŒçºŒè«‹æ±‚æ”œå¸¶ Token                â”‚
     â”‚     Header: Authorization: Bearer xxx â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                                       â”‚
```

**é—œéµè¨­è¨ˆé»ï¼š**
- âœ… ç„¡ç‹€æ…‹èªè­‰ï¼šä¼ºæœå™¨ä¸ä¿å­˜ Session
- âœ… Token éæœŸæ©Ÿåˆ¶ï¼šAccess Token 1å¤©ï¼ŒRefresh Token 7å¤©
- âœ… è‡ªå‹•æ›´æ–°ï¼šå‰ç«¯æ””æˆª 401 éŒ¯èª¤ï¼Œè‡ªå‹•è·³è½‰ç™»å…¥

### 2. æ–‡ä»¶ç·¨è¼¯æµç¨‹ï¼ˆHTTP + WebSocketï¼‰

```
ç”¨æˆ¶ A ç·¨è¼¯æ–‡ä»¶
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

æ­¥é©Ÿ 1: è¼‰å…¥æ–‡ä»¶ (HTTP)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ A  â”‚  GET /api/documents/{id}/          â”‚   API        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  Authorization: Bearer xxx         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ 1. é©—è­‰ JWT  â”‚
â”‚         â”‚                                    â”‚ 2. æª¢æŸ¥æ¬Šé™  â”‚
â”‚         â”‚                                    â”‚ 3. æŸ¥è©¢æ–‡ä»¶  â”‚
â”‚         â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤              â”‚
â”‚         â”‚  { id, title, content, ... }       â”‚              â”‚
â”‚ Quill   â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ æ¸²æŸ“    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥é©Ÿ 2: å»ºç«‹ WebSocket é€£æ¥ï¼ˆä½¿ç”¨ Subprotocol èªè­‰ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ A  â”‚  WS /ws/docs/{id}/                 â”‚  Consumer    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  Subprotocol: access_token.xxx     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ 1. èªè­‰      â”‚
â”‚         â”‚                                    â”‚    (JWT)     â”‚
â”‚         â”‚                                    â”‚ 2. æª¢æŸ¥æ¬Šé™  â”‚
â”‚         â”‚                                    â”‚ 3. åŠ å…¥ç¾¤çµ„  â”‚
â”‚         â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤    doc_xxx   â”‚
â”‚  é€£æ¥   â”‚  WebSocket å»ºç«‹æˆåŠŸ                â”‚              â”‚
â”‚  æˆåŠŸ   â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥é©Ÿ 3: å³æ™‚ç·¨è¼¯åŒæ­¥ (WebSocket)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ A  â”‚                                    â”‚  Consumer A  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”‚  ç”¨æˆ¶è¼¸å…¥ "Hello"                  â”‚              â”‚
â”‚ Quill   â”‚  â”€â–¶ text-change äº‹ä»¶               â”‚              â”‚
â”‚ Delta   â”‚  â”€â–¶ {ops: [{insert: "Hello"}]}    â”‚              â”‚
â”‚         â”‚                                    â”‚              â”‚
â”‚         â”‚  ç™¼é€ Delta                        â”‚              â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ 1. æ¥æ”¶      â”‚
â”‚         â”‚  {delta: {...}}                    â”‚              â”‚
â”‚         â”‚                                    â”‚ 2. 5å±¤é©—è­‰   â”‚
â”‚         â”‚                                    â”‚    (Schema)  â”‚
â”‚         â”‚                                    â”‚ 3. å»£æ’­      â”‚
â”‚         â”‚                                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”‚                                    â”‚ Channel      â”‚
â”‚         â”‚                                    â”‚ Layer        â”‚
â”‚         â”‚                                    â”‚ (Redis)      â”‚
â”‚         â”‚                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚         â”‚                                           â”‚
â”‚         â”‚                                    å»£æ’­çµ¦ç¾¤çµ„
â”‚         â”‚                                           â”‚
â”‚         â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”
â”‚         â”‚                                    â”‚  Consumer B  â”‚
â”‚         â”‚                                    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”                                   â”‚ 1. æ¥æ”¶å»£æ’­  â”‚
â”‚ å‰ç«¯ B   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 2. éæ¿¾è‡ªå·±  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  {delta: {...}}                   â”‚ 3. è½‰ç™¼å‰ç«¯  â”‚
â”‚ Quill    â”‚                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ æ‡‰ç”¨     â”‚
â”‚ Delta    â”‚  â”€â–¶ æ›´æ–°å…§å®¹ï¼ˆ'silent' æ¨¡å¼ï¼‰
â”‚          â”‚  â”€â–¶ ç”¨æˆ¶ B çœ‹åˆ° "Hello"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ­¥é©Ÿ 4: ä¿å­˜æ–‡ä»¶ (HTTP)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ A  â”‚                                    â”‚   API        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  Debounce 1.5ç§’å¾Œ                 â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚         â”‚  PUT /api/documents/{id}/          â”‚ 1. æ›´æ–°è³‡æ–™åº«â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ 2. å»£æ’­äº‹ä»¶  â”‚
â”‚         â”‚  {title, content}                  â”‚   (Channel)  â”‚
â”‚         â”‚                                    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚         â”‚                                           â”‚
â”‚         â”‚                                           â–¼
â”‚         â”‚                                    æ‰€æœ‰é€£æ¥çš„ç”¨æˆ¶
â”‚         â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€æ”¶åˆ° doc_saved
â”‚         â”‚  {type: 'doc_saved', updated_at}   äº‹ä»¶
â”‚ æ›´æ–°    â”‚
â”‚ ç‹€æ…‹    â”‚  "All changes saved"
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**é—œéµè¨­è¨ˆé»ï¼š**
- âœ… **é›™é€šé“è¨­è¨ˆ**ï¼šHTTP ç”¨æ–¼æŒä¹…åŒ–ï¼ŒWebSocket ç”¨æ–¼å³æ™‚åŒæ­¥
- âœ… **Echo Prevention**ï¼šä¸å°‡è¨Šæ¯ç™¼å›åŸå§‹ç™¼é€è€…
- âœ… **Silent Mode**ï¼šæ‡‰ç”¨é ç«¯ Delta æ™‚ä¸è§¸ç™¼äº‹ä»¶ï¼Œé¿å…ç„¡é™å¾ªç’°
- âœ… **Debounce**ï¼šæ¸›å°‘ API è«‹æ±‚ï¼Œæå‡æ•ˆèƒ½

### 3. å”ä½œè€…ç®¡ç†æµç¨‹

```
æ–‡ä»¶æ‰€æœ‰è€…åˆ†äº«æ–‡ä»¶çµ¦å…¶ä»–ç”¨æˆ¶ï¼ˆæ”¯æ´æ¬Šé™ç´šåˆ¥ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯    â”‚  POST /api/documents/{id}/         â”‚   API        â”‚
â”‚ (Owner) â”‚       collaborators/               â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  {username: "user_b",              â”‚              â”‚
â”‚         â”‚   permission: "write"}             â”‚ 1. é©—è­‰æ‰€æœ‰æ¬Šâ”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚    (owner?)  â”‚
â”‚         â”‚                                    â”‚              â”‚
â”‚         â”‚                                    â”‚ 2. æŸ¥æ‰¾ç”¨æˆ¶  â”‚
â”‚         â”‚                                    â”‚    User.get  â”‚
â”‚         â”‚                                    â”‚              â”‚
â”‚         â”‚                                    â”‚ 3. å»ºç«‹å”ä½œè€…â”‚
â”‚         â”‚                                    â”‚ Collaborator â”‚
â”‚         â”‚                                    â”‚   .create()  â”‚
â”‚         â”‚                                    â”‚              â”‚
â”‚         â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤ 4. è¿”å›çµæœ  â”‚
â”‚         â”‚  {id, username, email, permission} â”‚              â”‚
â”‚         â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  æ›´æ–°   â”‚
â”‚  åˆ—è¡¨   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

æ¬Šé™ç´šåˆ¥èªªæ˜ï¼š
  - writeï¼ˆç·¨è¼¯ï¼‰ï¼šå¯è®€å–ã€ç·¨è¼¯ã€WebSocket ç™¼é€ delta
  - readï¼ˆåªè®€ï¼‰ï¼šå¯è®€å–ã€WebSocket æ¥æ”¶ deltaï¼Œä½†ä¸èƒ½ç·¨è¼¯

ç”¨æˆ¶ Bï¼ˆç·¨è¼¯æ¬Šé™ writeï¼‰å¯ä»¥ï¼š
  âœ… GET /api/documents/{id}/    (è®€å–æ–‡ä»¶)
  âœ… PUT /api/documents/{id}/    (ç·¨è¼¯æ–‡ä»¶)
  âœ… WebSocket é€£æ¥ + ç™¼é€       (å³æ™‚å”ä½œ)
  âŒ DELETE /api/documents/{id}/ (ä¸èƒ½åˆªé™¤)
  âŒ ç®¡ç†å”ä½œè€…                   (ä¸èƒ½æ·»åŠ /ç§»é™¤)

ç”¨æˆ¶ Cï¼ˆåªè®€æ¬Šé™ readï¼‰å¯ä»¥ï¼š
  âœ… GET /api/documents/{id}/    (è®€å–æ–‡ä»¶)
  âŒ PUT /api/documents/{id}/    (403 Forbidden)
  âœ… WebSocket é€£æ¥              (å³æ™‚æ¥æ”¶æ›´æ–°)
  âŒ WebSocket ç™¼é€ delta        (READ_ONLY éŒ¯èª¤)
  âŒ DELETEã€ç®¡ç†å”ä½œè€…           (ä¸èƒ½)
```

**é©—è­‰è¦å‰‡ï¼š**
- âŒ æ“æœ‰è€…ä¸èƒ½å°‡è‡ªå·±æ·»åŠ ç‚ºå”ä½œè€…ï¼ˆHTTP 400 éŒ¯èª¤ï¼‰
- âŒ permission å¿…é ˆæ˜¯ 'read' æˆ– 'write'ï¼ˆHTTP 400 éŒ¯èª¤ï¼‰

---

## ğŸ§© æ ¸å¿ƒæ¨¡çµ„è¨­è¨ˆ

### å¾Œç«¯æ¨¡çµ„æ¶æ§‹

```
backend/
â”œâ”€â”€ backend/                    # å°ˆæ¡ˆé…ç½®
â”‚   â”œâ”€â”€ settings.py            # Django é…ç½®
â”‚   â”‚   â”œâ”€ è³‡æ–™åº«é…ç½®
â”‚   â”‚   â”œâ”€ ä¸­é–“ä»¶é…ç½®
â”‚   â”‚   â”œâ”€ CORS è¨­å®š
â”‚   â”‚   â”œâ”€ JWT é…ç½®
â”‚   â”‚   â””â”€ Channel Layer é…ç½®
â”‚   â”œâ”€â”€ urls.py                # URL è·¯ç”±
â”‚   â”œâ”€â”€ asgi.py                # ASGI å…¥å£ï¼ˆWebSocketï¼‰
â”‚   â””â”€â”€ wsgi.py                # WSGI å…¥å£ï¼ˆHTTPï¼‰
â”‚
â””â”€â”€ docs_app/                   # æ ¸å¿ƒæ‡‰ç”¨
    â”œâ”€â”€ models.py              # ğŸ“¦ è³‡æ–™æ¨¡å‹å±¤
    â”‚   â”œâ”€â”€ Document           # æ–‡ä»¶æ¨¡å‹
    â”‚   â”‚   â”œâ”€ æ¬„ä½å®šç¾©
    â”‚   â”‚   â”œâ”€ é—œè¯é—œä¿‚
    â”‚   â”‚   â””â”€ æ¥­å‹™æ–¹æ³•
    â”‚   â””â”€â”€ DocumentVersion    # ç‰ˆæœ¬æ­·å²æ¨¡å‹
    â”‚       â”œâ”€ å®Œæ•´å…§å®¹å¿«ç…§
    â”‚       â”œâ”€ ç‰ˆæœ¬è™Ÿç®¡ç†
    â”‚       â””â”€ æ¸…ç†èˆŠç‰ˆæœ¬
    â”‚
    â”œâ”€â”€ api.py                 # ğŸŒ API æ§åˆ¶å™¨å±¤
    â”‚   â””â”€â”€ DocumentController
    â”‚       â”œâ”€ CRUD ç«¯é»
    â”‚       â”œâ”€ æ¬Šé™æª¢æŸ¥
    â”‚       â”œâ”€ å”ä½œè€…ç®¡ç†
    â”‚       â””â”€ ç‰ˆæœ¬æ­·å² API
    â”‚
    â”œâ”€â”€ auth_api.py            # ğŸ” èªè­‰æ§åˆ¶å™¨
    â”‚   â””â”€â”€ AuthController
    â”‚       â”œâ”€ è¨»å†Š
    â”‚       â”œâ”€ ç™»å…¥
    â”‚       â””â”€ Token ç®¡ç†
    â”‚
    â”œâ”€â”€ ai_api.py              # ğŸ¤– AI æ§åˆ¶å™¨
    â”‚   â””â”€â”€ AIController
    â”‚       â””â”€ æ–‡å­—è™•ç†ï¼ˆæ‘˜è¦/æ½¤ç¨¿ï¼‰
    â”‚
    â”œâ”€â”€ comment_api.py         # ğŸ’¬ è©•è«–æ§åˆ¶å™¨
    â”‚   â””â”€â”€ CommentController
    â”‚       â”œâ”€ è©•è«– CRUD
    â”‚       â”œâ”€ å›è¦†åŠŸèƒ½
    â”‚       â””â”€ WebSocket å»£æ’­
    â”‚
    â”œâ”€â”€ ai_service.py          # ğŸ§  AI æœå‹™å±¤
    â”‚   â””â”€â”€ AIService
    â”‚       â”œâ”€ Gemini API æ•´åˆ
    â”‚       â”œâ”€ Prompt æ¨¡æ¿
    â”‚       â””â”€ å»¶é²åˆå§‹åŒ–
    â”‚
    â”œâ”€â”€ ai_rate_limiter.py     # â±ï¸ AI é€Ÿç‡é™åˆ¶
    â”‚   â””â”€â”€ AIRateLimiter
    â”‚       â””â”€ Redis æ»‘å‹•çª—å£
    â”‚
    â”œâ”€â”€ consumers.py           # ğŸ“¡ WebSocket æ¶ˆè²»è€…
    â”‚   â””â”€â”€ DocConsumer
    â”‚       â”œâ”€ é€£æ¥ç®¡ç†
    â”‚       â”œâ”€ æ¬Šé™é©—è­‰
    â”‚       â”œâ”€ è¨Šæ¯è™•ç†
    â”‚       â””â”€ å»£æ’­é‚è¼¯
    â”‚
    â”œâ”€â”€ routing.py             # ğŸ›£ï¸ WebSocket è·¯ç”±
    â”œâ”€â”€ auth_middleware.py     # ğŸ”’ WebSocket èªè­‰ä¸­é–“ä»¶
    â”œâ”€â”€ connection_manager.py  # ğŸ”— WebSocket é€£æ¥æ•¸é‡ç®¡ç†
    â”œâ”€â”€ rate_limiter.py        # â±ï¸ æ¶ˆæ¯é€Ÿç‡é™åˆ¶
    â”‚
    â””â”€â”€ tests/                 # ğŸ§ª æ¸¬è©¦
        â”œâ”€â”€ conftest.py        # æ¸¬è©¦é…ç½®
        â”œâ”€â”€ test_models.py     # æ¨¡å‹æ¸¬è©¦
        â”œâ”€â”€ test_api.py        # API æ¸¬è©¦
        â”œâ”€â”€ test_auth.py       # èªè­‰æ¸¬è©¦
        â”œâ”€â”€ test_ai_api.py     # AI API æ¸¬è©¦
        â”œâ”€â”€ test_consumers.py  # WebSocket æ¸¬è©¦
        â”œâ”€â”€ test_auth_middleware.py  # èªè­‰ä¸­é–“ä»¶æ¸¬è©¦
        â””â”€â”€ test_routing.py    # WebSocket è·¯ç”±æ¸¬è©¦
```

### å‰ç«¯æ¨¡çµ„æ¶æ§‹

```
frontend/
â””â”€â”€ src/
    â”œâ”€â”€ routes/                      # ğŸ“„ é é¢è·¯ç”±
    â”‚   â”œâ”€â”€ +layout.svelte          # å…¨å±€ä½ˆå±€
    â”‚   â”œâ”€â”€ +page.svelte            # é¦–é 
    â”‚   â”œâ”€â”€ login/                  # ç™»å…¥é 
    â”‚   â”œâ”€â”€ register/               # è¨»å†Šé 
    â”‚   â””â”€â”€ (protected)/            # éœ€èªè­‰çš„è·¯ç”±ç¾¤çµ„
    â”‚       â”œâ”€â”€ dashboard/          # æ–‡ä»¶åˆ—è¡¨
    â”‚       â”‚   â””â”€â”€ +page.svelte
    â”‚       â”‚       â”œâ”€ æ–‡ä»¶åˆ—è¡¨å±•ç¤º
    â”‚       â”‚       â”œâ”€ å‰µå»ºæ–°æ–‡ä»¶
    â”‚       â”‚       â””â”€ API èª¿ç”¨
    â”‚       â”‚
    â”‚       â””â”€â”€ docs/
    â”‚           â””â”€â”€ [document_id]/  # æ–‡ä»¶ç·¨è¼¯é 
    â”‚               â””â”€â”€ +page.svelte    # Svelte 5 Runes èªæ³•
    â”‚                   â”œâ”€ Quill ç·¨è¼¯å™¨æ•´åˆ
    â”‚                   â”œâ”€ WebSocket å³æ™‚é€£æ¥
    â”‚                   â”œâ”€ `$state()` ç‹€æ…‹ç®¡ç†
    â”‚                   â”œâ”€ `$derived.by()` è¨ˆç®—ç‹€æ…‹
    â”‚                   â”œâ”€ `$effect()` è‡ªå‹•ä¿å­˜é‚è¼¯
    â”‚                   â””â”€ å”ä½œè€…ç®¡ç† UI
    â”‚
    â””â”€â”€ lib/                         # ğŸ”§ å…±äº«æ¨¡çµ„
        â”œâ”€â”€ auth.ts                  # èªè­‰å·¥å…·
        â”‚   â”œâ”€ API å°è£ï¼ˆget, post, put, delï¼‰
        â”‚   â”œâ”€ Token ç®¡ç†
        â”‚   â””â”€ éŒ¯èª¤è™•ç†
        â”‚
        â”œâ”€â”€ ai.ts                    # ğŸ¤– AI API æ¨¡çµ„
        â”‚   â”œâ”€ processWithAI()
        â”‚   â””â”€ è¶…æ™‚è™•ç†
        â”‚
        â”œâ”€â”€ api/                     # ğŸ”Œ API æ¨¡çµ„
        â”‚   â”œâ”€â”€ versions.ts          # ç‰ˆæœ¬æ­·å² API
        â”‚   â”‚   â”œâ”€ getVersions()
        â”‚   â”‚   â”œâ”€ getVersionDetail()
        â”‚   â”‚   â””â”€ restoreVersion()
        â”‚   â”‚
        â”‚   â””â”€â”€ comments.ts          # è©•è«– API
        â”‚       â”œâ”€ getComments()
        â”‚       â”œâ”€ createComment()
        â”‚       â”œâ”€ updateComment()
        â”‚       â””â”€ deleteComment()
        â”‚
        â””â”€â”€ components/              # ğŸ¨ å¯è¤‡ç”¨çµ„ä»¶
            â”œâ”€â”€ QuillEditor.svelte   # Quill ç·¨è¼¯å™¨çµ„ä»¶ï¼ˆSvelte 5 Runesï¼‰
            â”‚   â”œâ”€ `$props()` + `$bindable()` é›™å‘ç¶å®š
            â”‚   â”œâ”€ `$effect()` ç›£è½å…§å®¹è®ŠåŒ–
            â”‚   â”œâ”€ callback props äº‹ä»¶è™•ç†
            â”‚   â””â”€ ç·¨è¼¯å™¨åˆå§‹åŒ–èˆ‡æ¨£å¼
            â”‚
            â”œâ”€â”€ AIDialog.svelte      # AI å¯«ä½œåŠ©æ‰‹å°è©±æ¡†
            â”‚   â”œâ”€ æ‘˜è¦/æ½¤ç¨¿åŠŸèƒ½
            â”‚   â”œâ”€ Loading ç‹€æ…‹
            â”‚   â””â”€ çµæœé è¦½èˆ‡å¥—ç”¨
            â”‚
            â”œâ”€â”€ VersionHistoryPanel.svelte  # ç‰ˆæœ¬æ­·å²é¢æ¿
            â”‚   â”œâ”€ ç‰ˆæœ¬åˆ—è¡¨é¡¯ç¤º
            â”‚   â”œâ”€ ç‰ˆæœ¬é¸æ“‡èˆ‡é è¦½
            â”‚   â””â”€ é‚„åŸç‰ˆæœ¬åŠŸèƒ½
            â”‚
            â””â”€â”€ CommentPanel.svelte     # è©•è«–é¢æ¿çµ„ä»¶
                â”œâ”€ è©•è«–åˆ—è¡¨é¡¯ç¤º
                â”œâ”€ æ–°å¢/ç·¨è¼¯/åˆªé™¤è©•è«–
                â””â”€ WebSocket å³æ™‚åŒæ­¥
```

### æ•¸æ“šæ¨¡å‹è¨­è¨ˆ

#### Document æ¨¡å‹

```python
class Document(models.Model):
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¸»éµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    id = UUIDField(primary_key=True, default=uuid4)
    # è¨­è¨ˆç†ç”±ï¼š
    # âœ“ UUID ä¸å¯é æ¸¬ï¼Œå¢åŠ å®‰å…¨æ€§
    # âœ“ åˆ†æ•£å¼ç³»çµ±å‹å–„ï¼Œä¸æœƒè¡çª
    # âœ“ ä¸æ´©æ¼ç³»çµ±è³‡è¨Šï¼ˆå¦‚æ–‡ä»¶ç¸½æ•¸ï¼‰

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ åŸºæœ¬è³‡è¨Š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    title = CharField(max_length=255)
    content = JSONField(default=dict)
    # è¨­è¨ˆç†ç”±ï¼š
    # âœ“ JSONField ç›´æ¥å„²å­˜ Quill Delta
    # âœ“ é¿å… HTML XSS é¢¨éšª
    # âœ“ çµæ§‹åŒ–è³‡æ–™ï¼Œæ˜“æ–¼è™•ç†

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ‰€æœ‰æ¬Š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    owner = ForeignKey(User, on_delete=CASCADE, related_name='owned_documents')
    # è¨­è¨ˆç†ç”±ï¼š
    # âœ“ æ˜ç¢ºçš„æ‰€æœ‰æ¬Šé—œä¿‚
    # âœ“ CASCADEï¼šç”¨æˆ¶åˆªé™¤æ™‚ï¼Œæ–‡ä»¶ä¹Ÿåˆªé™¤
    # âœ“ related_nameï¼šåå‘æŸ¥è©¢ç”¨æˆ¶æ“æœ‰çš„æ–‡ä»¶

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å”ä½œé—œä¿‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    # é€é DocumentCollaborator ä¸­é–“æ¨¡å‹ç®¡ç†ï¼ˆæ”¯æ´ read/write æ¬Šé™ï¼‰
    # è¨­è¨ˆç†ç”±ï¼š
    # âœ“ ä¸­é–“æ¨¡å‹æ”¯æ´æ¬Šé™ç´šåˆ¥ï¼ˆåªè®€/ç·¨è¼¯ï¼‰
    # âœ“ å¯æ“´å±•ï¼šæœªä¾†å¯æ·»åŠ  invited_byã€expires_at ç­‰æ¬„ä½
    # âœ“ å¯©è¨ˆè¿½è¹¤ï¼šè¨˜éŒ„å”ä½œé—œä¿‚å‰µå»ºæ™‚é–“

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ™‚é–“æˆ³ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    created_at = DateTimeField(auto_now_add=True)
    updated_at = DateTimeField(auto_now=True)
    # è¨­è¨ˆç†ç”±ï¼š
    # âœ“ è‡ªå‹•ç®¡ç†ï¼Œç„¡éœ€æ‰‹å‹•è¨­ç½®
    # âœ“ ç”¨æ–¼æ’åºå’Œé¡¯ç¤º

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å…ƒæ•¸æ“š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    class Meta:
        ordering = ['-updated_at']  # æœ€è¿‘ç·¨è¼¯çš„åœ¨å‰
        indexes = [
            Index(fields=['owner', '-updated_at']),  # å„ªåŒ–ç”¨æˆ¶æ–‡ä»¶åˆ—è¡¨æŸ¥è©¢
            Index(fields=['-created_at']),           # å„ªåŒ–æŒ‰å‰µå»ºæ™‚é–“æ’åº
        ]
```

**è³‡æ–™åº«é—œä¿‚åœ–ï¼š**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚      User       â”‚         â”‚    Document     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)         â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”‚ owner_id (FK)   â”‚
â”‚ username        â”‚    1:N  â”‚ id (PK, UUID)   â”‚
â”‚ email           â”‚         â”‚ title           â”‚
â”‚ password        â”‚         â”‚ content (JSON)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ created_at      â”‚
         â”‚                  â”‚ updated_at      â”‚
         â”‚                  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                           â”‚
         â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚    â”‚
         â–¼    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   DocumentCollaborator      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK)                     â”‚
â”‚ document_id (FK) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ user_id (FK) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ permission (read/write)     â”‚
â”‚ created_at                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    (é¡¯å¼ä¸­é–“æ¨¡å‹ï¼Œæ”¯æ´æ¬Šé™ç´šåˆ¥)

         â”‚
         â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     DocumentVersion         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ id (PK, UUID)               â”‚
â”‚ document_id (FK) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ content (JSON) - å®Œæ•´å¿«ç…§   â”‚
â”‚ created_by_id (FK, nullable)â”‚
â”‚ version_number (int)        â”‚
â”‚ created_at                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    (ç‰ˆæœ¬æ­·å²ï¼Œå®Œæ•´å…§å®¹å¿«ç…§)
```

#### DocumentVersion æ¨¡å‹

```python
class DocumentVersion(models.Model):
    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ä¸»éµ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    id = UUIDField(primary_key=True, default=uuid4)

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ é—œè¯æ–‡ä»¶ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    document = ForeignKey(Document, on_delete=CASCADE, related_name='versions')
    # è¨­è¨ˆç†ç”±ï¼š
    # âœ“ CASCADEï¼šæ–‡ä»¶åˆªé™¤æ™‚ï¼Œç‰ˆæœ¬ä¹Ÿåˆªé™¤
    # âœ“ related_nameï¼šå¯ç”¨ document.versions æŸ¥è©¢ç‰ˆæœ¬åˆ—è¡¨

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç‰ˆæœ¬å…§å®¹ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    content = JSONField(default=dict)  # å®Œæ•´ Quill Delta å¿«ç…§
    # è¨­è¨ˆç†ç”±ï¼š
    # âœ“ å®Œæ•´å¿«ç…§æ–¹æ¡ˆï¼šå¯¦ä½œç°¡å–®ã€é‚„åŸç›´æ¥
    # âœ“ æ¯æ¬¡ä¿å­˜éƒ½å‰µå»ºå®Œæ•´å‰¯æœ¬
    # âœ“ ç‰ˆæœ¬ä¸Šé™ 50 å€‹ï¼Œè‡ªå‹•æ¸…ç†èˆŠç‰ˆæœ¬

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å‰µå»ºè€… â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    created_by = ForeignKey(User, on_delete=SET_NULL, null=True)
    # è¨­è¨ˆç†ç”±ï¼š
    # âœ“ SET_NULLï¼šç”¨æˆ¶åˆªé™¤å¾Œä¿ç•™ç‰ˆæœ¬è¨˜éŒ„
    # âœ“ å¯©è¨ˆè¿½è¹¤ï¼šçŸ¥é“èª°å‰µå»ºäº†ç‰ˆæœ¬

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ ç‰ˆæœ¬è™Ÿ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    version_number = PositiveIntegerField()
    # è¨­è¨ˆç†ç”±ï¼š
    # âœ“ éå¢ç‰ˆæœ¬è™Ÿï¼Œæ–¹ä¾¿ç”¨æˆ¶è­˜åˆ¥
    # âœ“ unique_together ç¢ºä¿å”¯ä¸€æ€§

    # â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ å…ƒæ•¸æ“š â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    class Meta:
        ordering = ['-version_number']
        unique_together = ['document', 'version_number']
        indexes = [
            Index(fields=['document', '-version_number']),
        ]
```

---

## ğŸ¨ è¨­è¨ˆæ¨¡å¼

### 1. Repository Patternï¼ˆå€‰å„²æ¨¡å¼ï¼‰

é›–ç„¶æœ¬å°ˆæ¡ˆæœªå®Œå…¨å¯¦ç¾ï¼Œä½†æ¬Šé™æª¢æŸ¥æ–¹æ³•é«”ç¾äº†é€™å€‹æ¦‚å¿µï¼š

```python
class DocumentController:
    def _get_user_accessible_documents_query(self, user):
        """çµ±ä¸€çš„æŸ¥è©¢é‚è¼¯"""
        return Q(owner=user) | Q(shared_with=user)

    def _get_document_with_permission_check(self, document_id, user, owner_only=False):
        """çµ±ä¸€çš„æ¬Šé™æª¢æŸ¥é‚è¼¯"""
        # é›†ä¸­ç®¡ç†è³‡æ–™è¨ªå•å’Œæ¬Šé™
```

**å„ªé»ï¼š**
- âœ… å–®ä¸€çœŸç›¸ä¾†æº
- âœ… æ˜“æ–¼æ¸¬è©¦
- âœ… æ˜“æ–¼ç¶­è­·

### 2. Middleware Patternï¼ˆä¸­é–“ä»¶æ¨¡å¼ï¼‰

```python
# WebSocket èªè­‰ä¸­é–“ä»¶
class JWTAuthMiddleware:
    def __init__(self, app):
        self.app = app

    async def __call__(self, scope, receive, send):
        # 1. é è™•ç†ï¼šèªè­‰
        token = extract_token_from_query(scope)
        scope['user'] = await authenticate(token)

        # 2. èª¿ç”¨ä¸‹ä¸€å±¤
        return await self.app(scope, receive, send)
```

**æ‡‰ç”¨å ´æ™¯ï¼š**
- èªè­‰/æˆæ¬Š
- æ—¥èªŒè¨˜éŒ„
- CORS è™•ç†
- éŒ¯èª¤è™•ç†

### 3. Observer Patternï¼ˆè§€å¯Ÿè€…æ¨¡å¼ï¼‰

Channel Layer å¯¦ç¾äº†è§€å¯Ÿè€…æ¨¡å¼ï¼š

```python
# ç™¼å¸ƒè€…
await self.channel_layer.group_send(
    'doc_123',  # ä¸»é¡Œ
    {'type': 'doc_update', 'delta': {...}}  # äº‹ä»¶
)

# è¨‚é–±è€…
async def doc_update(self, event):
    # æ”¶åˆ°é€šçŸ¥ï¼Œè™•ç†äº‹ä»¶
    await self.send(...)
```

**å„ªé»ï¼š**
- âœ… é¬†è€¦åˆ
- âœ… å¤šå°å¤šé€šçŸ¥
- âœ… æ˜“æ–¼æ“´å±•

### 4. Strategy Patternï¼ˆç­–ç•¥æ¨¡å¼ï¼‰

Quill çš„ `source` åƒæ•¸é«”ç¾äº†ç­–ç•¥æ¨¡å¼ï¼š

```typescript
editor.updateContents(delta, 'user');    // ç”¨æˆ¶è¼¸å…¥ç­–ç•¥
editor.updateContents(delta, 'api');     // API æ›´æ–°ç­–ç•¥
editor.updateContents(delta, 'silent');  // éœé»˜ç­–ç•¥
```

ä¸åŒçš„ `source` è§¸ç™¼ä¸åŒçš„è¡Œç‚ºï¼ˆäº‹ä»¶è™•ç†ï¼‰ã€‚

### 5. Facade Patternï¼ˆå¤–è§€æ¨¡å¼ï¼‰

å‰ç«¯çš„ `auth.ts` æä¾›äº†çµ±ä¸€çš„ API ä»‹é¢ï¼š

```typescript
// å¤–è§€ï¼šç°¡åŒ–çš„ API
export async function get(url: string) {
    const token = getToken();
    const response = await fetch(url, {
        headers: { Authorization: `Bearer ${token}` }
    });
    return handleResponse(response);
}

// ä½¿ç”¨è€…ä¸éœ€è¦é—œå¿ƒï¼š
// - Token å¾å“ªè£¡ä¾†
// - å¦‚ä½•è¨­ç½® Header
// - å¦‚ä½•è™•ç†éŒ¯èª¤
```

---

## ğŸ¤” æŠ€è¡“é¸å‹ç†ç”±

### Quill.js vs å…¶ä»–ç·¨è¼¯å™¨

**ç‚ºä»€éº¼é¸æ“‡ Quillï¼Ÿ**

| ç‰¹æ€§ | Quill | TinyMCE | Draft.js |
|------|-------|---------|----------|
| Delta æ¨¡å‹ | âœ… åŸç”Ÿ | âŒ | âš ï¸ è¤‡é›œ |
| å³æ™‚å”ä½œ | âœ… å®Œç¾ | âš ï¸ å›°é›£ | âœ… å¯ä»¥ |
| API ç°¡æ½”åº¦ | âœ… | âš ï¸ | âŒ |
| æ–‡æª”å“è³ª | âœ… | âœ… | âš ï¸ |
| å­¸ç¿’æ›²ç·š | ğŸ“ˆ å¹³ç·© | ğŸ“ˆ ä¸­ç­‰ | ğŸ“ˆ é™¡å³­ |

**æ±ºç­–é—œéµï¼š**
- Delta æ¨¡å‹æ˜¯æ•™å­¸é‡é»
- é©åˆå”ä½œå ´æ™¯
- API å‹å–„ï¼Œæ˜“æ–¼æ•´åˆ

### PostgreSQL vs MySQL

**ç‚ºä»€éº¼é¸æ“‡ PostgreSQLï¼Ÿ**

- âœ… JSONField æ”¯æ´æ›´å¥½ï¼ˆåŸç”Ÿ JSON å‹åˆ¥ï¼‰
- âœ… å…¨æ–‡æœç´¢èƒ½åŠ›æ›´å¼·
- âœ… æ“´å±•æ€§æ›´å¥½
- âœ… é–‹æºç¤¾ç¾¤æ›´æ´»èº

### Redis vs In-Memory

**ç‚ºä»€éº¼é¸æ“‡ Redisï¼Ÿ**

```python
# In-Memory Channel Layerï¼ˆåƒ…é–‹ç™¼ç’°å¢ƒï¼‰
CHANNEL_LAYERS = {
    "default": {
        "BACKEND": "channels.layers.InMemoryChannelLayer"
    }
}
# âŒ å•é¡Œï¼šä¸æ”¯æ´å¤šä¼ºæœå™¨å¯¦ä¾‹

# Redis Channel Layerï¼ˆç”Ÿç”¢ç’°å¢ƒï¼‰
CHANNEL_LAYERS = {
    "default": {
        "BACKEND": "channels_redis.core.RedisChannelLayer",
        # ...
    }
}
# âœ… å„ªå‹¢ï¼šæ”¯æ´æ°´å¹³æ“´å±•
```

---

## ğŸ” å®‰å…¨æ€§è¨­è¨ˆ

### 1. èªè­‰å®‰å…¨

```python
# JWT Token é…ç½®
NINJA_JWT = {
    'ACCESS_TOKEN_LIFETIME': timedelta(days=1),      # çŸ­æœŸæœ‰æ•ˆ
    'REFRESH_TOKEN_LIFETIME': timedelta(days=7),     # é•·æœŸæœ‰æ•ˆ
    'SIGNING_KEY': SECRET_KEY,                        # ç°½åå¯†é‘°
}
```

**å®‰å…¨æªæ–½ï¼š**
- âœ… Token ç°½åé˜²ç¯¡æ”¹
- âœ… éæœŸæ™‚é–“é™åˆ¶
- âœ… Refresh Token è¼ªæ›æ©Ÿåˆ¶
- âœ… WebSocket ä½¿ç”¨ Subprotocol å‚³é Tokenï¼ˆä¸åœ¨ URL ä¸­ï¼‰

### 2. æ¬Šé™æ§åˆ¶

**ä¸‰å±¤é˜²è­·ï¼š**

```python
# 1. è£é£¾å™¨ç´šåˆ¥
@api_controller("/documents", auth=JWTAuth(), permissions=[IsAuthenticated])

# 2. æ–¹æ³•ç´šåˆ¥
def _get_document_with_permission_check(self, document_id, user, owner_only=False):
    # æª¢æŸ¥æ˜¯å¦ owner æˆ– shared_with

# 3. æŸ¥è©¢ç´šåˆ¥
Q(owner=user) | Q(shared_with=user)  # è³‡æ–™åº«å±¤é¢éæ¿¾
```

### 3. XSS é˜²è­·

```python
# âœ… ä½¿ç”¨ JSONField å„²å­˜ Deltaï¼Œä¸å„²å­˜ HTML
content = models.JSONField(default=dict)

# âŒ å¦‚æœå„²å­˜ HTML
content = models.TextField()  # é¢¨éšªï¼š<script>alert('xss')</script>
```

### 4. CSRF é˜²è­·

```python
# Django å…§å»º CSRF ä¸­é–“ä»¶
MIDDLEWARE = [
    'django.middleware.csrf.CsrfViewMiddleware',
    # ...
]

# API ä½¿ç”¨ JWTï¼Œä¸éœ€è¦ CSRF Token
```

### 5. SQL æ³¨å…¥é˜²è­·

```python
# âœ… ä½¿ç”¨ ORMï¼Œè‡ªå‹•é˜²è­·
Document.objects.filter(owner=user)

# âŒ åŸå§‹ SQLï¼ˆæ•™å­¸é …ç›®ä¸ä½¿ç”¨ï¼‰
cursor.execute(f"SELECT * FROM document WHERE owner={user.id}")  # å±éšªï¼
```

### 6. WebSocket å®‰å…¨æ©Ÿåˆ¶

**èªè­‰å¤±æ•—è™•ç†ï¼š**
- âœ… é€£æ¥å¤±æ•—æ™‚ç™¼é€å…·é«”éŒ¯èª¤åŸå› ï¼ˆtype: connection_errorï¼‰
- âœ… ä½¿ç”¨ WebSocket Close Codes (4001-4008)
- âœ… æ”¯æŒå¤šç¨®éŒ¯èª¤é¡å‹ï¼šTOKEN_EXPIREDã€PERMISSION_DENIEDã€DOCUMENT_NOT_FOUND ç­‰

**é€£æ¥æ•¸é‡é™åˆ¶ï¼š**
```python
# æ¯ç”¨æˆ¶æœ€å¤š 5 å€‹ä¸¦ç™¼ WebSocket é€£æ¥ï¼ˆå¯é…ç½®ï¼‰
WEBSOCKET_MAX_CONNECTIONS_PER_USER = 5
```
- âœ… ä½¿ç”¨ Redis SET è¿½è¹¤æ´»èºé€£æ¥
- âœ… Lua è…³æœ¬ç¢ºä¿åŸå­æ€§æ“ä½œ
- âœ… é˜²æ­¢å–®ä¸€ç”¨æˆ¶è³‡æºè€—ç›¡

**é€£æ¥ç”Ÿå‘½é€±æœŸç®¡ç†ï¼š**
```python
# é€£æ¥ TTLï¼ˆç§’ï¼‰- é˜²æ­¢é€£ç·šæ®˜ç•™
WEBSOCKET_CONNECTION_TTL = 300  # 5 åˆ†é˜

# å¿ƒè·³é–“éš”ï¼ˆç§’ï¼‰- åˆ·æ–°æ´»èºé€£ç·š TTL
WEBSOCKET_HEARTBEAT_INTERVAL = 120  # 2 åˆ†é˜
```
- âœ… è‡ªå‹•éæœŸï¼šé€£ç·šè¨˜éŒ„ 5 åˆ†é˜å¾Œè‡ªå‹•æ¸…é™¤
- âœ… å¿ƒè·³åˆ·æ–°ï¼šæ´»èºé€£ç·šæ¯ 2 åˆ†é˜åˆ·æ–° TTL
- âœ… Fail-Closedï¼šRedis éŒ¯èª¤æ™‚æ‹’çµ•æ–°é€£ç·šï¼ˆå®‰å…¨å„ªå…ˆï¼‰
- âœ… é‡è©¦æ©Ÿåˆ¶ï¼šç§»é™¤é€£ç·šæ™‚æœ€å¤šé‡è©¦ 3 æ¬¡ï¼ˆæŒ‡æ•¸é€€é¿ï¼‰

**æ¶ˆæ¯é€Ÿç‡é™åˆ¶ï¼š**
```python
# æ»‘å‹•çª—å£ç®—æ³•ï¼šæ¯ 10 ç§’æœ€å¤š 30 æ¢æ¶ˆæ¯
WEBSOCKET_RATE_LIMIT_MESSAGES = 30
WEBSOCKET_RATE_LIMIT_WINDOW = 10
```
- âœ… ä½¿ç”¨ Redis Sorted Set å¯¦ç¾æ»‘å‹•çª—å£
- âœ… è¿”å› retry_after æç¤ºå®¢æˆ¶ç«¯ç­‰å¾…æ™‚é–“
- âœ… é˜²æ­¢æƒ¡æ„å®¢æˆ¶ç«¯æ¿«ç™¼æ¶ˆæ¯

**æ¶ˆæ¯é©—è­‰ï¼š**
- âœ… æ¶ˆæ¯å¤§å°é™åˆ¶ï¼ˆ256KBï¼‰
- âœ… Pydantic Schema é©—è­‰ Delta æ ¼å¼
- âœ… æ“ä½œæ•¸é‡é™åˆ¶ï¼ˆ1000 å€‹ opsï¼‰

---

## âš¡ æ•ˆèƒ½è€ƒé‡

### 1. è³‡æ–™åº«æŸ¥è©¢å„ªåŒ–

```python
# âŒ N+1 æŸ¥è©¢å•é¡Œ
documents = Document.objects.all()
for doc in documents:
    print(doc.owner.username)  # æ¯æ¬¡éƒ½æŸ¥è©¢è³‡æ–™åº«ï¼

# âœ… ä½¿ç”¨ select_relatedï¼ˆä¸€å°å¤šï¼‰
documents = Document.objects.select_related('owner').all()
# åªåŸ·è¡Œä¸€æ¬¡ JOIN æŸ¥è©¢

# âœ… ä½¿ç”¨ prefetch_relatedï¼ˆå¤šå°å¤šï¼‰
documents = Document.objects.prefetch_related('shared_with').all()
# åŸ·è¡Œå…©æ¬¡æŸ¥è©¢ï¼Œä½†ç¸½é«”æ›´é«˜æ•ˆ
```

**å·²å¯¦ç¾çš„å„ªåŒ–ï¼š**
```python
# api.py
documents = Document.objects.select_related('owner').filter(query).distinct()
```

### 2. å‰ç«¯æ•ˆèƒ½å„ªåŒ–

**Debounce è‡ªå‹•ä¿å­˜ï¼š**
```typescript
const debouncedSave = () => {
    clearTimeout(debounceTimeout);
    debounceTimeout = setTimeout(async () => {
        await put(`/documents/${documentId}/`, { title, content });
    }, 1500);  // 1.5 ç§’å¾Œæ‰ä¿å­˜
};
```

**æ•ˆæœï¼š**
- âŒ ç„¡ Debounceï¼šæ¯æ¬¡æŒ‰éµéƒ½ç™¼é€è«‹æ±‚ï¼ˆå¯èƒ½æ•¸ç™¾æ¬¡ï¼‰
- âœ… æœ‰ Debounceï¼šåœæ­¢è¼¸å…¥ 1.5 ç§’å¾Œæ‰ç™¼é€ï¼ˆåƒ… 1 æ¬¡ï¼‰

### 3. WebSocket è¨Šæ¯å„ªåŒ–

#### å¾Œç«¯ï¼šé¿å… Echoï¼ˆå›è²ï¼‰

```python
async def doc_update(self, event):
    sender_channel = event.get('sender_channel')
    if self.channel_name != sender_channel:  # ä¸ç™¼å›åŸå§‹ç™¼é€è€…
        await self.send(...)
```

**ç¯€çœï¼š**
- 50% çš„ç¶²è·¯æµé‡ï¼ˆé›™å‘ â†’ å–®å‘ï¼‰
- é¿å…ç„¡é™å¾ªç’°

#### å‰ç«¯ï¼šThrottle æ©Ÿåˆ¶

```typescript
// ä½¿ç”¨ throttle æ§åˆ¶ WebSocket ç™¼é€é »ç‡
const THROTTLE_INTERVAL = 150; // ms

// ç´¯ç© delta ä¸¦åˆä½µ
if (pendingDelta) {
    pendingDelta = { ops: d1.compose(d2).ops };
}
```

**é…åˆè¨­è¨ˆï¼š**

| å±¤ç´š | æ©Ÿåˆ¶ | é…ç½® | æ•ˆæœ |
|------|------|------|------|
| å‰ç«¯ | Throttle | 150ms é–“éš” | ~7 æ¢/ç§’ |
| å¾Œç«¯ | æ»‘å‹•çª—å£ | 30 æ¢/10 ç§’ | é˜²æ­¢æ¿«ç”¨ |

**Throttle vs Debounceï¼š**

| æ©Ÿåˆ¶ | ç”¨é€” | å»¶é² |
|------|------|------|
| Throttle | WebSocket å³æ™‚åŒæ­¥ | æœ€å¤§ 150ms |
| Debounce | HTTP API å„²å­˜ | 1.5 ç§’ |

### 4. ç´¢å¼•å„ªåŒ–

```python
class Meta:
    indexes = [
        Index(fields=['owner', '-updated_at']),  # è¤‡åˆç´¢å¼•
        Index(fields=['-created_at']),
    ]
```

**æŸ¥è©¢åŠ é€Ÿï¼š**
- æ–‡ä»¶åˆ—è¡¨é ï¼š`O(log n)` vs `O(n)`
- ç‰¹åˆ¥æ˜¯å¤§é‡æ–‡ä»¶æ™‚æ•ˆæœé¡¯è‘—

### 5. Redis ä½¿ç”¨ç­–ç•¥

**Channel Layerï¼ˆWebSocket å»£æ’­ï¼‰ï¼š**
```python
CHANNEL_LAYERS = {
    "default": {
        "BACKEND": "channels_redis.core.RedisChannelLayer",
        "CONFIG": {"hosts": [(REDIS_HOST, REDIS_PORT)]},
    }
}
```

**é€£æ¥è¿½è¹¤ï¼ˆSET + TTLï¼‰ï¼š**
```
Key: ws:connections:user:{user_id}
Type: SET
Members: [channel_name_1, channel_name_2, ...]
TTL: 300 ç§’ï¼ˆ5 åˆ†é˜ï¼‰
```
- Lua è…³æœ¬ç¢ºä¿åŸå­æ€§ï¼ˆæª¢æŸ¥ + æ·»åŠ åœ¨åŒä¸€æ“ä½œï¼‰
- å¿ƒè·³åˆ·æ–° TTLï¼Œé˜²æ­¢æ´»èºé€£ç·šè¢«èª¤æ¸…é™¤
- ç•°å¸¸æ–·ç·šæ™‚ç”± TTL è‡ªå‹•æ¸…ç†ï¼ˆç„¡éœ€æ‰‹å‹•æ¸…é™¤ï¼‰

**é€Ÿç‡é™åˆ¶ï¼ˆSorted Setï¼‰ï¼š**
```
Key: ws:ratelimit:user:{user_id}:doc:{document_id}
Type: SORTED SET
Score: timestamp
```
- æ»‘å‹•çª—å£ç®—æ³•ï¼Œç„¡éœ€å®šæœŸæ¸…ç†
- è‡ªå‹•éæœŸæ©Ÿåˆ¶ï¼ˆçª—å£ Ã— 2ï¼‰

---

## ğŸš€ æ“´å±•æ€§è¨­è¨ˆ

æœ¬å°ˆæ¡ˆçš„æ¶æ§‹è¨­è¨ˆè€ƒé‡äº†æœªä¾†æ“´å±•çš„å¯èƒ½æ€§ï¼š

| è¨­è¨ˆæ±ºç­– | æ“´å±•æ½›åŠ› |
|---------|---------|
| **ç„¡ç‹€æ…‹ APIï¼ˆJWTï¼‰** | å¯æ°´å¹³æ“´å±•ï¼Œæ”¯æ´è² è¼‰å‡è¡¡ |
| **Redis Channel Layer** | æ”¯æ´å¤šä¼ºæœå™¨å¯¦ä¾‹é–“çš„ WebSocket é€šè¨Š |
| **PostgreSQL JSONField** | éˆæ´»çš„è³‡æ–™çµæ§‹ï¼Œæ˜“æ–¼æ“´å±•æ¬„ä½ |
| **æ¨¡çµ„åŒ–è¨­è¨ˆ** | æ˜“æ–¼æ–°å¢ API ç«¯é»å’Œ WebSocket äº‹ä»¶é¡å‹ |

> ğŸ’¡ **æ³¨æ„**ï¼šä½œç‚ºæ•™å­¸å°ˆæ¡ˆï¼Œé€™äº›æ“´å±•èƒ½åŠ›æœªå¯¦éš›å¯¦ç¾ï¼Œä½†è¨­è¨ˆä¸Šé ç•™äº†ç©ºé–“ã€‚

---

## ğŸ“š å»¶ä¼¸é–±è®€

- [Django å®˜æ–¹æ–‡æª”](https://docs.djangoproject.com/)
- [Django Ninja æ–‡æª”](https://django-ninja.rest-framework.com/)
- [SvelteKit æ–‡æª”](https://kit.svelte.dev/)
- [Quill Delta è¦ç¯„](https://quilljs.com/docs/delta/)
- [Django Channels æ–‡æª”](https://channels.readthedocs.io/)
- [WebSocket RFC](https://tools.ietf.org/html/rfc6455)
- [JWT æ¨™æº–](https://tools.ietf.org/html/rfc7519)
- [RESTful API è¨­è¨ˆæŒ‡å—](https://restfulapi.net/)

---

**æœ¬æ–‡æª”æŒçºŒæ›´æ–°ä¸­ã€‚å¦‚æœ‰å•é¡Œæˆ–å»ºè­°ï¼Œæ­¡è¿æ Issueï¼** ğŸš€
